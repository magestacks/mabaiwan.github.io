<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>花一个周末，掌握 OpenFeign 核心原理 | 小马哥の代码实战课</title>
    <meta name="description" content="">
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/assets/xiaomage-logo.JPG">
    <script type="text/javascript" src="/assets/js/push.js"></script>
    <script charset="utf-8" src="https://my.openwrite.cn/js/readmore.js"></script>
    <meta name="description" content="一个不是在造轮子，就是在造轮子路上的程序员，追求优雅编码。写过博客，参与过开源项目，热衷于基础架构。">
    <meta name="referrer" content="never">
    <meta name="keywords" content="antdocs,antdeisgn,vuepress,vuepress-theme,theme,ant,docs,antd,antdocs of vuepress,主题,vuepress主题,antd设计,blog,vuepress-blog">
    <link rel="preload" href="/assets/css/0.styles.b37e4d9f.css" as="style"><link rel="preload" href="/assets/js/app.7eb18571.js" as="script"><link rel="preload" href="/assets/js/2.670b9761.js" as="script"><link rel="preload" href="/assets/js/23.54f25aab.js" as="script"><link rel="prefetch" href="/assets/js/10.a5a9903d.js"><link rel="prefetch" href="/assets/js/11.5762fdcb.js"><link rel="prefetch" href="/assets/js/12.3d30dbb9.js"><link rel="prefetch" href="/assets/js/13.167f50d8.js"><link rel="prefetch" href="/assets/js/14.73090bec.js"><link rel="prefetch" href="/assets/js/15.c99b25a1.js"><link rel="prefetch" href="/assets/js/16.8e1e672b.js"><link rel="prefetch" href="/assets/js/17.3f44f769.js"><link rel="prefetch" href="/assets/js/18.eb50631d.js"><link rel="prefetch" href="/assets/js/19.b81fb5c1.js"><link rel="prefetch" href="/assets/js/20.9e106839.js"><link rel="prefetch" href="/assets/js/21.899094ac.js"><link rel="prefetch" href="/assets/js/22.20904317.js"><link rel="prefetch" href="/assets/js/24.9980ebcd.js"><link rel="prefetch" href="/assets/js/25.3068a180.js"><link rel="prefetch" href="/assets/js/26.b9dbabce.js"><link rel="prefetch" href="/assets/js/27.fe33b48c.js"><link rel="prefetch" href="/assets/js/28.53c3669d.js"><link rel="prefetch" href="/assets/js/29.aea97b6c.js"><link rel="prefetch" href="/assets/js/3.f8b3c6d2.js"><link rel="prefetch" href="/assets/js/30.601a6826.js"><link rel="prefetch" href="/assets/js/31.c8fd8006.js"><link rel="prefetch" href="/assets/js/32.679c3c46.js"><link rel="prefetch" href="/assets/js/33.0632bf2f.js"><link rel="prefetch" href="/assets/js/34.87ee7489.js"><link rel="prefetch" href="/assets/js/35.ae124e8e.js"><link rel="prefetch" href="/assets/js/36.0b5e4932.js"><link rel="prefetch" href="/assets/js/37.241fb3e7.js"><link rel="prefetch" href="/assets/js/38.20592ee2.js"><link rel="prefetch" href="/assets/js/39.bec8855a.js"><link rel="prefetch" href="/assets/js/4.fa07bc29.js"><link rel="prefetch" href="/assets/js/40.19c4f912.js"><link rel="prefetch" href="/assets/js/41.efec0c07.js"><link rel="prefetch" href="/assets/js/5.ac01bbe0.js"><link rel="prefetch" href="/assets/js/6.e506f546.js"><link rel="prefetch" href="/assets/js/7.929e0a1e.js"><link rel="prefetch" href="/assets/js/8.5a319efc.js"><link rel="prefetch" href="/assets/js/9.0dc60c38.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b37e4d9f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="ant-row"><div class="nav-button"><i aria-label="icon: bars" class="anticon anticon-bars"><svg viewBox="0 0 1024 1024" focusable="false" data-icon="bars" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M912 192H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 284H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 284H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM104 228a56 56 0 1 0 112 0 56 56 0 1 0-112 0zm0 284a56 56 0 1 0 112 0 56 56 0 1 0-112 0zm0 284a56 56 0 1 0 112 0 56 56 0 1 0-112 0z"></path></svg></i> <span></span></div> <div class="ant-col ant-col-xs-24 ant-col-sm-24 ant-col-md-6 ant-col-lg-6 ant-col-xl-5 ant-col-xxl-4"><a href="/" class="router-link-active home-link"><img src="/assets/xiaomage-logo.JPG" alt="小马哥の代码实战课" class="logo"> <span class="site-name">小马哥の代码实战课</span></a> <div class="search-box mobile-search"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div> <div class="ant-col ant-col-xs-0 ant-col-sm-0 ant-col-md-18 ant-col-lg-18 ant-col-xl-19 ant-col-xxl-20"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><ul role="menu" id="nav" class="ant-menu ant-menu-horizontal ant-menu-root ant-menu-light"><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-item"><a href="/" class="router-link-active">
          首页
        </a></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-item"><a href="https://sourl.cn/ruwYW4" target="_blank">
          🥇代码实战课
          <i aria-label="icon: link" class="anticon anticon-link"><svg viewBox="64 64 896 896" focusable="false" data-icon="link" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M574 665.4a8.03 8.03 0 0 0-11.3 0L446.5 781.6c-53.8 53.8-144.6 59.5-204 0-59.5-59.5-53.8-150.2 0-204l116.2-116.2c3.1-3.1 3.1-8.2 0-11.3l-39.8-39.8a8.03 8.03 0 0 0-11.3 0L191.4 526.5c-84.6 84.6-84.6 221.5 0 306s221.5 84.6 306 0l116.2-116.2c3.1-3.1 3.1-8.2 0-11.3L574 665.4zm258.6-474c-84.6-84.6-221.5-84.6-306 0L410.3 307.6a8.03 8.03 0 0 0 0 11.3l39.7 39.7c3.1 3.1 8.2 3.1 11.3 0l116.2-116.2c53.8-53.8 144.6-59.5 204 0 59.5 59.5 53.8 150.2 0 204L665.3 562.6a8.03 8.03 0 0 0 0 11.3l39.8 39.8c3.1 3.1 8.2 3.1 11.3 0l116.2-116.2c84.5-84.6 84.5-221.5 0-306.1zM610.1 372.3a8.03 8.03 0 0 0-11.3 0L372.3 598.7a8.03 8.03 0 0 0 0 11.3l39.6 39.6c3.1 3.1 8.2 3.1 11.3 0l226.4-226.4c3.1-3.1 3.1-8.2 0-11.3l-39.5-39.6z"></path></svg></i></a></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-item"><a href="/docs/thread/thread-pool-thread-destroy.html">
          技术笔记
        </a></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="visibility:hidden;position:absolute;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li></ul> <ul class="extra-group"><li><a href="https://github.com/mageeric" target="_blank" rel="noopener noreferrer" class="repo-link"><i aria-label="icon: github" class="anticon anticon-github"><svg viewBox="64 64 896 896" focusable="false" data-icon="github" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M511.6 76.3C264.3 76.2 64 276.4 64 523.5 64 718.9 189.3 885 363.8 946c23.5 5.9 19.9-10.8 19.9-22.2v-77.5c-135.7 15.9-141.2-73.9-150.3-88.9C215 726 171.5 718 184.5 703c30.9-15.9 62.4 4 98.9 57.9 26.4 39.1 77.9 32.5 104 26 5.7-23.5 17.9-44.5 34.7-60.8-140.6-25.2-199.2-111-199.2-213 0-49.5 16.3-95 48.3-131.7-20.4-60.5 1.9-112.3 4.9-120 58.1-5.2 118.5 41.6 123.2 45.3 33-8.9 70.7-13.6 112.9-13.6 42.4 0 80.2 4.9 113.5 13.9 11.3-8.6 67.3-48.8 121.3-43.9 2.9 7.7 24.7 58.3 5.5 118 32.4 36.8 48.9 82.7 48.9 132.3 0 102.2-59 188.1-200 212.9a127.5 127.5 0 0 1 38.1 91v112.5c.8 9 0 17.9 15 17.9 177.1-59.7 304.6-227 304.6-424.1 0-247.2-200.4-447.3-447.5-447.3z"></path></svg></i></a></li> <!----></ul></nav></div></div> <!----></header> <aside class="sidebar"><div><div class="promo"><div id="promo_3"><div class="promo_title">赞助商</div> <button type="button" class="ant-btn ant-btn-primary ant-btn-background-ghost"><span>成为赞助商</span></button></div></div> <div role="separator" id="reset-margin" class="ant-divider ant-divider-horizontal ant-divider-dashed"></div></div>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>并发编程</span> <span class="arrow right"><i aria-label="icon: down" class="anticon anticon-down"><svg viewBox="64 64 896 896" focusable="false" data-icon="down" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M884 256h-75c-5.1 0-9.9 2.5-12.9 6.6L512 654.2 227.9 262.6c-3-4.1-7.8-6.6-12.9-6.6h-75c-6.5 0-10.3 7.4-6.5 12.7l352.6 486.1c12.8 17.6 39 17.6 51.7 0l352.6-486.1c3.9-5.3.1-12.7-6.4-12.7z"></path></svg></i></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>设计模式</span> <span class="arrow right"><i aria-label="icon: down" class="anticon anticon-down"><svg viewBox="64 64 896 896" focusable="false" data-icon="down" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M884 256h-75c-5.1 0-9.9 2.5-12.9 6.6L512 654.2 227.9 262.6c-3-4.1-7.8-6.6-12.9-6.6h-75c-6.5 0-10.3 7.4-6.5 12.7l352.6 486.1c12.8 17.6 39 17.6 51.7 0l352.6-486.1c3.9-5.3.1-12.7-6.4-12.7z"></path></svg></i></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>场景问题</span> <span class="arrow right"><i aria-label="icon: down" class="anticon anticon-down"><svg viewBox="64 64 896 896" focusable="false" data-icon="down" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M884 256h-75c-5.1 0-9.9 2.5-12.9 6.6L512 654.2 227.9 262.6c-3-4.1-7.8-6.6-12.9-6.6h-75c-6.5 0-10.3 7.4-6.5 12.7l352.6 486.1c12.8 17.6 39 17.6 51.7 0l352.6-486.1c3.9-5.3.1-12.7-6.4-12.7z"></path></svg></i></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>分布式篇</span> <span class="arrow right"><i aria-label="icon: down" class="anticon anticon-down"><svg viewBox="64 64 896 896" focusable="false" data-icon="down" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M884 256h-75c-5.1 0-9.9 2.5-12.9 6.6L512 654.2 227.9 262.6c-3-4.1-7.8-6.6-12.9-6.6h-75c-6.5 0-10.3 7.4-6.5 12.7l352.6 486.1c12.8 17.6 39 17.6 51.7 0l352.6-486.1c3.9-5.3.1-12.7-6.4-12.7z"></path></svg></i></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>框架学习</span> <span class="arrow down"><i aria-label="icon: down" class="anticon anticon-down"><svg viewBox="64 64 896 896" focusable="false" data-icon="down" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M884 256h-75c-5.1 0-9.9 2.5-12.9 6.6L512 654.2 227.9 262.6c-3-4.1-7.8-6.6-12.9-6.6h-75c-6.5 0-10.3 7.4-6.5 12.7l352.6 486.1c12.8 17.6 39 17.6 51.7 0l352.6-486.1c3.9-5.3.1-12.7-6.4-12.7z"></path></svg></i></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/frame/mybatis.html" title="Mybatis 核心架构设计分享" class="sidebar-link">Mybatis 核心架构设计分享</a></li><li><a href="/docs/frame/mybatis-dynamic-proxy.html" title="心态崩了呀！Mybatis 动态代理这么玩？！" class="sidebar-link">心态崩了呀！Mybatis 动态代理这么玩？！</a></li><li><a href="/docs/frame/open-feign.html" aria-current="page" title="花一个周末，掌握 OpenFeign 核心原理" class="active sidebar-link">花一个周末，掌握 OpenFeign 核心原理</a></li><li><a href="/docs/frame/ribbon.html" title="花一个周末，掌握 SpringCloud Ribbon 核心原理" class="sidebar-link">花一个周末，掌握 SpringCloud Ribbon 核心原理</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>读书笔记</span> <span class="arrow right"><i aria-label="icon: down" class="anticon anticon-down"><svg viewBox="64 64 896 896" focusable="false" data-icon="down" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M884 256h-75c-5.1 0-9.9 2.5-12.9 6.6L512 654.2 227.9 262.6c-3-4.1-7.8-6.6-12.9-6.6h-75c-6.5 0-10.3 7.4-6.5 12.7l352.6 486.1c12.8 17.6 39 17.6 51.7 0l352.6-486.1c3.9-5.3.1-12.7-6.4-12.7z"></path></svg></i></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-antdocs-content content__default"><h1 id="花一个周末-掌握-openfeign-核心原理">花一个周末，掌握 OpenFeign 核心原理 <a href="#花一个周末-掌握-openfeign-核心原理" class="header-anchor">#</a></h1> <p>现在的微服务在互联网圈子里应用已经相关广泛了，SpringCloud 是微服务领域当之无愧的 &quot;头牌&quot;</p> <p>加上现在的一些轮子项目，新建一个全套的 SpringCloud 项目分分钟的事情，而我们要做的事情，就是不把认知停留在使用层面，所以要深入到源码中去理解 SpringCloud</p> <p><strong>为什么要选择 OpenFien？</strong> 因为它足够的 &quot;小&quot;，符合我们的标题：<strong>一个周末搞定</strong></p> <p>Feign 的源代码中，Java 代码才 3w 多行，放眼现在热门的开源项目，包括不限于 Dubbo、Naocs、Skywalking 中 Java 代码都要 30w 行起步</p> <p>通过本篇文章，希望读者朋友可以掌握如下知识</p> <ul><li>什么是 Feign</li> <li>Feign 和 Openfeign 的区别</li> <li>OpenFeign 的启动原理</li> <li>OpenFeign 的工作原理</li> <li>OpenFeign 如何负载均衡</li></ul> <blockquote><p>spring-cloud-starter-openfeign version：2.2.6.RELEASE</p></blockquote> <h2 id="什么是-feign">什么是 Feign <a href="#什么是-feign" class="header-anchor">#</a></h2> <p>Feign 是声明式 Web 服务客户端，它使编写 Web 服务客户端更加容易</p> <p>Feign 不做任何请求处理，通过处理注解相关信息生成 Request，并对调用返回的数据进行解码，从而实现 <strong>简化 HTTP API 的开发</strong></p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210117103547767.png" alt=""></p> <p>如果要使用 Feign，需要创建一个接口并对其添加 Feign 相关注解，另外 Feign <strong>还支持可插拔编码器和解码器</strong>，致力于打造一个轻量级 HTTP 客户端</p> <h2 id="feign-和-openfeign-的区别">Feign 和 Openfeign 的区别 <a href="#feign-和-openfeign-的区别" class="header-anchor">#</a></h2> <p>Feign 最早是由 <strong>Netflix 公司进行维护的</strong>，后来 Netflix 不再对其进行维护，最终 <strong>Feign 由社区进行维护</strong>，更名为 Openfeign</p> <blockquote><p>为了少打俩字，下文简称 Opefeign 为 Feign</p></blockquote> <p>并将原项目迁移至新的仓库，所以我们在 Github 上看到 Feign 的坐标如下</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.github.openfeign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="starter-openfeign">Starter Openfeign <a href="#starter-openfeign" class="header-anchor">#</a></h3> <p>当然了，基于 SpringCloud 团队对 Netflix 的情有独钟，你出了这么好用的轻量级 HTTP 客户端，我这老大哥不得支持一下，所以就有了基于 Feign 封装的 Starter</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-openfeign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>Spring Cloud 添加了对 Spring MVC 注解的支持，并支持使用 Spring Web 中默认使用的相同 HttpMessageConverters</p> <p>另外，Spring Cloud 老大哥同时集成了 Ribbon 和 Eureka 以及 Spring Cloud LoadBalancer，以在使用 Feign 时提供负载均衡的 HTTP 客户端</p> <blockquote><p>针对于注册中心的支持，包含但不限于 Eureka，比如 Consul、Naocs 等注册中心均支持</p></blockquote> <p>在我们 SpringCloud 项目开发过程中，使用的大多都是这个 Starter Feign</p> <h2 id="环境准备">环境准备 <a href="#环境准备" class="header-anchor">#</a></h2> <p>为了方便大家理解，这里写出对应的生产方、消费方 Demo 代码，以及使用的注册中心</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210117200427532.png" alt=""></p> <p>注册中心使用的 Nacos，生产、消费方代码都比较简单。另外为了阅读体验感，<strong>文章原则是少放源码</strong>，更多的是给大家梳理核心逻辑</p> <h3 id="生产者服务">生产者服务 <a href="#生产者服务" class="header-anchor">#</a></h3> <p>添加 Nacos 服务注册发现注解以及发布出 HTTP 接口服务</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@EnableDiscoveryClient</span> <span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NacosProduceApplication</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">NacosProduceApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@RestController</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">TestController</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/hello&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token string">&quot;hello &quot;</span> <span class="token operator">+</span> name<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="消费者服务">消费者服务 <a href="#消费者服务" class="header-anchor">#</a></h3> <p>定义 FeignClient 消费服务接口</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;nacos-produce&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">DemoFeignClient</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/hello&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span>GET<span class="token punctuation">)</span>
    <span class="token class-name">String</span> <span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>因为生产者使用 Nacos，所以消费者除了开启 Feign 注解，同时也要开启 Naocs 服务注册发现</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span> <span class="token annotation punctuation">@EnableFeignClients</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span> <span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NacosConsumeApplication</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">NacosConsumeApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Autowired</span> <span class="token keyword">private</span> <span class="token class-name">DemoFeignClient</span> demoFeignClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/test&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> result <span class="token operator">=</span> demoFeignClient<span class="token punctuation">.</span><span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token string">&quot;公号-源码兴趣圈&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="feign-的启动原理">Feign 的启动原理 <a href="#feign-的启动原理" class="header-anchor">#</a></h2> <p>我们在 SpringCloud 的使用过程中，如果想要启动某个组件，一般都是 <strong>@Enable...</strong> 这种方式注入，Feign 也不例外，我们需要在类上标记此注解 <code>@EnableFeignClients</code></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@EnableFeignClients</span>
<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Application</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Application</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>继续深入看一下注解内部都做了什么。注解内部的方法就不说明了，不加会有默认的配置，感兴趣可以跟下源码</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span>RUNTIME<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span>TYPE<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Documented</span>
<span class="token annotation punctuation">@Import</span><span class="token punctuation">(</span><span class="token class-name">FeignClientsRegistrar</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">EnableFeignClients</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>
</code></pre></div><p>前三个注解看着平平无奇，重点在第四个 @Import 上，一般使用此注解都是想要动态注册 Spring Bean 的</p> <h3 id="注入-import">注入@Import <a href="#注入-import" class="header-anchor">#</a></h3> <p>通过名字也可以大致猜出来，这是 Feign 注册 Bean 使用的，使用到了 Spring 相关的接口，一起看下起了什么作用</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210116215150734.png" alt=""></p> <p>ResourceLoaderAware、EnvironmentAware 为 FeignClientsRegistrar 中两个属性 <strong>resourceLoader、environment</strong> 赋值，对 Spring 了解的小伙伴理解问题不大</p> <p>ImportBeanDefinitionRegistrar 负责动态注入 IOC Bean，分别注入 Feign 配置类、FeignClient Bean</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 资源加载器，可以加载 classpath 下的所有文件</span>
<span class="token keyword">private</span> <span class="token class-name">ResourceLoader</span> resourceLoader<span class="token punctuation">;</span>
<span class="token comment">// 上下文，可通过该环境获取当前应用配置属性等</span>
<span class="token keyword">private</span> <span class="token class-name">Environment</span> environment<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setEnvironment</span><span class="token punctuation">(</span><span class="token class-name">Environment</span> environment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>environment <span class="token operator">=</span> environment<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setResourceLoader</span><span class="token punctuation">(</span><span class="token class-name">ResourceLoader</span> resourceLoader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>resourceLoader <span class="token operator">=</span> resourceLoader<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">AnnotationMetadata</span> metadata<span class="token punctuation">,</span> <span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  	<span class="token comment">// 注册 ＠EnableFeignClients 提供的自定义配置类中的相关 Bean 实例</span>
    <span class="token function">registerDefaultConfiguration</span><span class="token punctuation">(</span>metadata<span class="token punctuation">,</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 扫描 packge，注册被 @FeignClient 修饰的接口类为 IOC Bean</span>
    <span class="token function">registerFeignClients</span><span class="token punctuation">(</span>metadata<span class="token punctuation">,</span> registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="添加全局配置">添加全局配置 <a href="#添加全局配置" class="header-anchor">#</a></h3> <p>registerDefaultConfiguration 方法流程如下</p> <ol><li>获取 @EnableFeignClients 注解上的属性以及对应 Value</li> <li>生成 <strong>FeignClientSpecification</strong>（存储 Feign 中的配置类） 对应的构造器 BeanDefinitionBuilder</li> <li>FeignClientSpecification Bean 名称为 default. + @EnableFeignClients 修饰类全限定名称 + FeignClientSpecification</li> <li>@EnableFeignClients defaultConfiguration 默认为 {}，如果没有相关配置，<code>默认使用 FeignClientsConfiguration</code> 并结合 name 填充到 FeignClientSpecification，最终注册为 IOC Bean</li></ol> <h3 id="注册-feignclient-接口">注册 FeignClient 接口 <a href="#注册-feignclient-接口" class="header-anchor">#</a></h3> <p>将重点放在 registerFeignClients 上，该方法主要就是将修饰了 @FeignClient 的接口注册为 IOC Bean</p> <ol><li>扫描 @EnableFeignClients 注解，如果有 clients，则加载指定接口，为空则根据 scanner 规则扫描出修饰了 @FeignClient 的接口</li> <li>获取 @FeignClient 上对应的属性，根据 configuration 属性去创建接口级的 <strong>FeignClientSpecification</strong> 配置类 IOC Bean</li> <li>将 @FeignClient 的属性设置到 <strong>FeignClientFactoryBean</strong> 对象上，并注册 IOC Bean</li></ol> <p>@FengnClient 修饰的接口实际上使用了 Spring 的代理工厂生成代理类，所以这里会把修饰了 @FeignClient 接口的 BeanDefinition 设置为 FeignClientFactoryBean 类型，而 <strong>FeignClientFactoryBean 继承自 FactoryBean</strong></p> <p>也就是说，当我们定义 @FeignClient 修饰接口时，注册到 IOC 容器中 Bean 类型变成了 FeignClientFactoryBean</p> <p>在 Spring 中，FactoryBean 是一个工厂 Bean，用来创建代理 Bean。<strong>工厂 Bean 是一种特殊的 Bean</strong>，对于需要获取 Bean 的消费者而言，它是不知道 Bean 是普通 Bean 或是工厂 Bean 的。<strong>工厂 Bean 返回的实例不是工厂 Bean 本身</strong>，而是会返回执行了工厂 Bean 中 <code>FactoryBean#getObject</code> 逻辑的实例</p> <h2 id="feign-的工作原理">Feign 的工作原理 <a href="#feign-的工作原理" class="header-anchor">#</a></h2> <p>说 Feign 的工作原理，核心点围绕在被 @FeignClient 修饰的接口，如何发送及接收 HTTP 网络请求</p> <p>上面说到 @FeignClient 修饰的接口最终填充到 IOC 容器的类型是 FeignClientFactoryBean，先来看下它是什么</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210117084610770.png" alt=""></p> <h3 id="factorybean-接口特征">FactoryBean 接口特征 <a href="#factorybean-接口特征" class="header-anchor">#</a></h3> <p>这里说一下 FeignClientFactoryBean 都有哪些特征</p> <ol><li>它会在类初始化时执行一段逻辑，依据 Spring <strong>InitializingBean</strong> 接口</li> <li>如果它被别的类 @Autowired 进行注入，返回的不是它本身，而是 <code>FactoryBean#getObject</code> 返回的类，依据 Spring <strong>FactoryBean</strong> 接口</li> <li>它能够获取 Spring 上下文对象，依据 Spring <strong>ApplicationContextAware</strong> 接口</li></ol> <p>先来看它的初始化逻辑都执行了什么</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>contextId<span class="token punctuation">,</span> <span class="token string">&quot;Context id must be set&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">&quot;Name must be set&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>没有特别的操作，只是使用断言工具类判断两个字段不为空。ApplicationContextAware 也没什么说的，获取上下文对象赋值到对象的局部变量里，重点以及关键就是 <code>FactoryBean#getObject</code> 方法</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">getTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>getTarget 源码方法还是挺长的，这里采用分段的形式展示</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">getTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  	<span class="token comment">// 从 IOC 容器获取 FeignContext</span>
    <span class="token class-name">FeignContext</span> context <span class="token operator">=</span> applicationContext<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">FeignContext</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  	<span class="token comment">// 通过 context 创建 Feign 构造器</span>
    <span class="token class-name">Feign<span class="token punctuation">.</span>Builder</span> builder <span class="token operator">=</span> <span class="token function">feign</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里提出一个疑问？FeignContext 什么时候、在哪里被注入到 Spring 容器里的？</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210117124204635.png" alt=""></p> <p>看到图片小伙伴就明了了，用了 SpringBoot 怎么会不使用自动装配的功能呢，FeignContext 就是在 FeignAutoConfiguration 中被成功创建</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210117135517855.png" alt=""></p> <h3 id="初始化父子容器">初始化父子容器 <a href="#初始化父子容器" class="header-anchor">#</a></h3> <p>feign 方法里日志工厂、编码、解码等类均是通过 get(...) 方法得到</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210117140151921.png" alt=""></p> <p>这里涉及到 Spring 父子容器的概念，<strong>默认子容器 Map 为空</strong>，获取不到服务名对应 Context 则新建</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210117140635516.png" alt=""></p> <p>从下图中看到，注册了一个 <strong>FeignClientsConfiguration</strong> 类型的 Bean，我们上述方法 feign 中的获取的编码、解码器等组件都是从此类中获取默认</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210117141800121.png" alt=""></p> <p>默认注册如下，FeignClientsConfiguration 是由创建 FeignContext 调用父类 Super 构造方法传入的</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210117142442921.png" alt=""></p> <p>关于父子类容器对应关系，以及提供 @FeignClient 服务对应子容器的关系（每一个服务对应一个子容器实例）</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210117144335432.png" alt=""></p> <p>回到 getInstance 方法，子容器此时已加载对应 Bean，直接通过 getBean 获取 <strong>FeignLoggerFactory</strong></p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210117142639778.png" alt=""></p> <p>如法炮制，Feign.Builder、Encoder、Decoder、Contract 都可以通过子容器获取对应 Bean</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210117145054652.png" alt=""></p> <p>configureFeign 方法主要进行一些配置赋值，<strong>比如超时、重试、404 配置等</strong>，就不再细说赋值代码了</p> <p>到这里有必要总结一下创建 Spring 代理工厂的前半场代码</p> <ol><li>注入@FeignClient 服务时，其实注入的是 <code>FactoryBean#getObject</code> 返回代理工厂对象</li> <li>通过 IOC 容器获取 FeignContext 上下文</li> <li>创建 Feign.Builder 对象时会创建 Feign 服务对应的子容器</li> <li>从子容器中获取日志工厂、编码器、解码器等 Bean</li> <li>为 Feign.Builder 设置配置，比如超时时间、日志级别等属性，每一个服务都可以个性化设置</li></ol> <h3 id="动态代理生成">动态代理生成 <a href="#动态代理生成" class="header-anchor">#</a></h3> <p>继续嗑，上面都是开胃菜，接下来是最最最重要的地方了，小板凳坐板正了..</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210117160135560.png" alt=""></p> <p>因为我们在 @FeignClient 注解是使用 name 而不是 url，所以会执行负载均衡策略的分支</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210117165403532.png" alt=""></p> <p>Client： Feign 发送请求以及接收响应等都是由 Client 完成，该类默认 Client.Default，另外支持 HttpClient、OkHttp 等客户端</p> <p>代码中的 Client、Targeter 在自动装配时注册，配合上文中的父子容器理论，这两个 Bean 在父容器中存在</p> <p>因为我们并没有对 Hystix 进行设置，所以走入此分支</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210117165809307.png" alt=""></p> <p>创建反射类 ReflectiveFeign，然后执行创建实例类</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210117170636104.png" alt=""></p> <p>newInstance 方法对 @FeignClient 修饰的接口中 SpringMvc 等配置进行解析转换，对接口类中的方法进行归类，生成动态代理类</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210117180843295.png" alt=""></p> <p>可以看出 Feign 创建动态代理类的方式和 Mybatis Mapper 处理方式是一致的，因为两者都没有实现类</p> <p>根据 newInstance 方法按照行为大致划分，共做了四件事</p> <ol><li>处理 @FeignCLient 注解（SpringMvc 注解等）封装为 <strong>MethodHandler</strong> 包装类</li> <li>遍历接口中所有方法，过滤 Object 方法，并将默认方法以及 FeignClient 方法分类</li> <li>创建动态代理对应的 <strong>InvocationHandler</strong> 并创建 Proxy 实例</li> <li>接口内 default 方法 <strong>绑定动态代理类</strong></li></ol> <p>MethodHandler 将方法参数、方法返回值、参数集合、请求类型、请求路径进行解析存储</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210117181818113.png" alt=""></p> <p>到这里我们也就可以 Feign 的工作方式了。前面那么多封装铺垫，封装个性化配置等等，最终确定收尾的是创建动态代理类</p> <p>也就是说在我们调用 @FeignClient 接口时，会被 <code>FeignInvocationHandler#invoke</code> 拦截，并在动态代理方法中执行下述逻辑</p> <ol><li>接口注解信息封装为 HTTP Request</li> <li>通过 Ribbon 获取服务列表，并对服务列表进行负载均衡调用（<strong>服务名转换为 ip+port</strong>）</li> <li>请求调用后，将返回的数据封装为 HTTP Response，继而转换为接口中的返回类型</li></ol> <p>既然已经明白了调用流程，那就正儿八经的试一哈，试过才知有没有...</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210117185730122.png" alt=""></p> <p>RequestTemplate：构建 Request 模版类</p> <p>Options：存放连接、超时时间等配置类</p> <p>Retryer：失败重试策略类</p> <blockquote><p>重试这一块逻辑看了很多遍，但是怎么看，一个 continue 关键字放到 while 的最后面都有点多余...</p></blockquote> <p>执行远端调用逻辑中使用到了 <strong>Rxjava （响应式编程）</strong>，可以看到通过底层获取 server 后将服务名称转变为 ip+port 的方式</p> <p>这种响应式编程的方式在 SpringCloud 中很常见，<strong>Hystix 源码底层也有使用</strong></p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210117192026553.png" alt=""></p> <p>网络调用默认使用 <strong>HttpURLConnection</strong>，可以配置使用 HttpClient 或者 OkHttp</p> <p>调用远端服务后，再将返回值解析正常返回，到这里一个完成的 Feign 调用链就聊明白了</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210117221147470.png" alt="图片参考@疯狂创客圈"></p> <h2 id="feign-如何负载均衡">Feign 如何负载均衡 <a href="#feign-如何负载均衡" class="header-anchor">#</a></h2> <p>一般而言，我们生产者注册多个服务，消费者调用时需要使用负载均衡从中 <strong>选取一个健康并且可用的生产者服务</strong></p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210117211229930.png" alt=""></p> <p>因为 Feign 内部集成 Ribbon，所以也支持此特性，一起看下它是怎么做的</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210117201548333.png" alt=""></p> <p>我们在 Nacos 上注册了两个服务，端口号 8080、8081。在获取负载均衡器时就可以获取服务集合</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210117202046064.png" alt=""></p> <p>然后通过 chooseServer 方法选择一个健康实例返回，后面会新出一篇文章对 Ribbon 的负载均衡详细说明</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210117202719314.png" alt=""></p> <p>通过返回的 Server 替换 URL 中的服务名，最后使用网络调用服务进行远端调用，完美的一匹</p> <h2 id="结语">结语 <a href="#结语" class="header-anchor">#</a></h2> <p>文章从最基础的知识介绍什么是 Feign？继而从源码的角度上说明 Feign 的底层原理，总结如下：</p> <ol><li>通过 @EnableFeignCleints 注解启动 Feign Starter 组件</li> <li>Feign Starter 在项目启动过程中注册全局配置，扫描包下所有的 @FeignClient 接口类，并进行注册 IOC 容器</li> <li>@FeignClient 接口类被注入时，通过 <code>FactoryBean#getObject</code> 返回动态代理类</li> <li>接口被调用时被动态代理类逻辑拦截，将 @FeignClient 请求信息通过编码器生成 Request</li> <li>交由 Ribbon 进行负载均衡，挑选出一个健康的 Server 实例</li> <li>继而通过 Client 携带 Request 调用远端服务返回请求响应</li> <li>通过解码器生成 Response 返回客户端，将信息流解析成为接口返回数据</li></ol> <p>虽然 Feign 体量相对小，但是想要一篇文章完全描述，也不太现实，所以这里都是挑一些核心点讲解，没有写到的地方还请见谅</p> <p>另外，由于作者水平有限, 欢迎大家能够反馈指正文章中错误不正确的地方, 感谢</p> <br> <p><strong>参考文章：</strong></p> <ul><li>https://blog.csdn.net/forezp/article/details/73480304</li> <li>https://www.cnblogs.com/yangxiaohui227/p/12965340.html</li> <li>https://www.cnblogs.com/crazymakercircle/p/11965726.html</li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">9/18/2022, 9:57:31 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/docs/frame/mybatis-dynamic-proxy.html" class="prev"><i aria-label="icon: left" class="anticon anticon-left"><svg viewBox="64 64 896 896" focusable="false" data-icon="left" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M724 218.3V141c0-6.7-7.7-10.4-12.9-6.3L260.3 486.8a31.86 31.86 0 0 0 0 50.3l450.8 352.1c5.3 4.1 12.9.4 12.9-6.3v-77.3c0-4.9-2.3-9.6-6.1-12.6l-360-281 360-281.1c3.8-3 6.1-7.7 6.1-12.6z"></path></svg></i>
        心态崩了呀！Mybatis 动态代理这么玩？！
      </a></span> <span class="next"><a href="/docs/frame/ribbon.html">
        花一个周末，掌握 SpringCloud Ribbon 核心原理
        <i aria-label="icon: right" class="anticon anticon-right"><svg viewBox="64 64 896 896" focusable="false" data-icon="right" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M765.7 486.8L314.9 134.7A7.97 7.97 0 0 0 302 141v77.3c0 4.9 2.3 9.6 6.1 12.6l360 281.1-360 281.1c-3.9 3-6.1 7.7-6.1 12.6V883c0 6.7 7.7 10.4 12.9 6.3l450.8-352.1a31.96 31.96 0 0 0 0-50.4z"></path></svg></i></a></span></p></div> <!----> </main> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.7eb18571.js" defer></script><script src="/assets/js/2.670b9761.js" defer></script><script src="/assets/js/23.54f25aab.js" defer></script>
  </body>
</html>