(window.webpackJsonp=window.webpackJsonp||[]).push([[29],{803:function(s,a,t){"use strict";t.r(a);var n=t(118),e=Object(n.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"如果线上遇到了-oom-该如何解决"}},[s._v("如果线上遇到了 OOM，该如何解决 "),t("a",{staticClass:"header-anchor",attrs:{href:"#如果线上遇到了-oom-该如何解决"}},[s._v("#")])]),s._v(" "),t("p",[s._v("OOM 意味着程序存在着漏洞，可能是代码或者 JVM 参数配置引起的。这篇文章和读者聊聊，Java 进程触发了 OOM 后如何排查")]),s._v(" "),t("p",[s._v("常说对生产环境保持敬畏之心，快速解决问题也是一种敬畏的表现")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://images-machen.oss-cn-beijing.aliyuncs.com/03cdefc08f92ce634f971a414e26f52a.png",alt:""}})]),s._v(" "),t("h2",{attrs:{id:"为什么会-oom"}},[s._v("为什么会 OOM "),t("a",{staticClass:"header-anchor",attrs:{href:"#为什么会-oom"}},[s._v("#")])]),s._v(" "),t("p",[s._v("OOM 全称 “Out Of Memory”，表示内存耗尽。当 JVM 因为没有足够的内存来为对象分配空间，并且垃圾回收器也已经没有空间可回收时，就会抛出这个错误")]),s._v(" "),t("p",[s._v("为什么会出现 OOM，一般由这些问题引起")]),s._v(" "),t("ol",[t("li",[s._v("分配过少：JVM 初始化内存小，业务使用了大量内存；或者不同 JVM 区域分配内存不合理")]),s._v(" "),t("li",[s._v("代码漏洞：某一个对象被频繁申请，不用了之后却没有被释放，导致内存耗尽")])]),s._v(" "),t("p",[t("strong",[s._v("内存泄漏")]),s._v("：申请使用完的内存没有释放，导致虚拟机不能再次使用该内存，此时这段内存就泄露了。因为申请者不用了，而又不能被虚拟机分配给别人用")]),s._v(" "),t("p",[t("strong",[s._v("内存溢出")]),s._v("：申请的内存超出了 JVM 能提供的内存大小，此时称之为溢出")]),s._v(" "),t("p",[s._v("内存泄漏持续存在，最后一定会溢出，两者是因果关系")]),s._v(" "),t("h2",{attrs:{id:"常见的-oom"}},[s._v("常见的 OOM "),t("a",{staticClass:"header-anchor",attrs:{href:"#常见的-oom"}},[s._v("#")])]),s._v(" "),t("p",[s._v("比较常见的 OOM 类型有以下几种")]),s._v(" "),t("p",[t("strong",[s._v("java.lang.OutOfMemoryError: PermGen space")])]),s._v(" "),t("p",[s._v("Java7 永久代（方法区）溢出，它用于存储已被虚拟机加载的类信息、常量、静态变量、即时编译器编译后的代码等数据。每当一个类初次加载的时候，元数据都会存放到永久代")]),s._v(" "),t("p",[s._v("一般出现于大量 Class 对象或者 JSP 页面，或者采用 CgLib 动态代理技术导致")]),s._v(" "),t("p",[s._v("我们可以通过 "),t("code",[s._v("-XX：PermSize")]),s._v(" 和 "),t("code",[s._v("-XX：MaxPermSize")]),s._v(" 修改方法区大小")]),s._v(" "),t("blockquote",[t("p",[s._v("Java8 将永久代变更为元空间，报错：java.lang.OutOfMemoryError: Metadata space，元空间内存不足默认进行动态扩展")])]),s._v(" "),t("p",[t("strong",[s._v("java.lang.StackOverflowError")])]),s._v(" "),t("p",[t("strong",[s._v("虚拟机栈溢出")]),s._v("，一般是由于程序中存在 "),t("strong",[s._v("死循环或者深度递归调用")]),s._v(" 造成的。如果栈大小设置过小也会出现溢出，可以通过 "),t("code",[s._v("-Xss")]),s._v(" 设置栈的大小")]),s._v(" "),t("p",[s._v("虚拟机抛出栈溢出错误，可以在日志中定位到错误的类、方法")]),s._v(" "),t("p",[t("strong",[s._v("java.lang.OutOfMemoryError: Java heap space")])]),s._v(" "),t("p",[t("strong",[s._v("Java 堆内存溢出")]),s._v("，溢出的原因一般由于 JVM 堆内存设置不合理或者内存泄漏导致")]),s._v(" "),t("p",[s._v("如果是内存泄漏，可以通过工具查看泄漏对象到 GC Roots 的引用链。掌握了泄漏对象的类型信息以及 GC Roots 引用链信息，就可以精准地定位出泄漏代码的位置")]),s._v(" "),t("p",[s._v("如果不存在内存泄漏，就是内存中的对象确实都还必须存活着，那就应该检查虚拟机的堆参数（-Xmx 与 -Xms），查看是否可以将虚拟机的内存调大些")]),s._v(" "),t("p",[s._v("小结：方法区和虚拟机栈的溢出场景不在本篇过多讨论，下面主要讲解常见的 Java 堆空间的 OOM 排查思路")]),s._v(" "),t("h2",{attrs:{id:"查看-jvm-内存分布"}},[s._v("查看 JVM 内存分布 "),t("a",{staticClass:"header-anchor",attrs:{href:"#查看-jvm-内存分布"}},[s._v("#")])]),s._v(" "),t("p",[s._v("假设我们 Java 应用 PID 为 15162，输入命令查看 JVM 内存分布 "),t("code",[s._v("jmap -heap 15162")])]),s._v(" "),t("div",{staticClass:"language-java extra-class"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("xxx"),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@xxx")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("~")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("# jmap "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("heap "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15162")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Attaching")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("to")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("process")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ID")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15162")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" please wait"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Debugger")]),s._v(" attached "),t("span",{pre:!0,attrs:{class:"token class-name"}},[t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("successfully"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),s._v("\nServer")]),s._v(" compiler detected"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\nJVM version is "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("25.161")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("b12\n\nusing thread"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("local object "),t("span",{pre:!0,attrs:{class:"token class-name"}},[t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("allocation"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),s._v("\nMark")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Sweep")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Compact")]),s._v(" GC\n\n"),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Heap")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Configuration")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\n   "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("MinHeapFreeRatio")]),s._v("         "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("40")]),s._v(" # 最小堆使用比例\n   "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("MaxHeapFreeRatio")]),s._v("         "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("70")]),s._v(" # 最大堆可用比例\n   "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("MaxHeapSize")]),s._v("              "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("482344960")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("460.0")]),s._v("MB"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" # 最大堆空间大小\n   "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("NewSize")]),s._v("                  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10485760")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.0")]),s._v("MB"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" # 新生代分配大小\n   "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("MaxNewSize")]),s._v("               "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("160759808")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("153.3125")]),s._v("MB"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" # 最大新生代可分配大小\n   "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("OldSize")]),s._v("                  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20971520")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20.0")]),s._v("MB"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" # 老年代大小\n   "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("NewRatio")]),s._v("                 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" # 新生代比例\n   "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SurvivorRatio")]),s._v("            "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v(" # 新生代与 "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Survivor")]),s._v(" 比例\n   "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("MetaspaceSize")]),s._v("            "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("21807104")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20.796875")]),s._v("MB"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" # 元空间大小\n   "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("CompressedClassSpaceSize")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1073741824")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1024.0")]),s._v("MB"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" # "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Compressed")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Class")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Space")]),s._v(" 空间大小限制\n   "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("MaxMetaspaceSize")]),s._v("         "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("17592186044415")]),s._v(" MB # 最大元空间大小\n   "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("G1HeapRegionSize")]),s._v("         "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v("MB"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" # G1 单个 "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Region")]),s._v(" 大小\n\n"),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Heap")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Usage")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("  # 堆使用情况\n"),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("New")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Generation")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Eden")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Survivor")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Space")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" # 新生代\n   capacity "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9502720")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9.0625")]),s._v("MB"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" # 新生代总容量\n   used     "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4995320")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4.763908386230469")]),s._v("MB"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" # 新生代已使用\n   free     "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4507400")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4.298591613769531")]),s._v("MB"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" # 新生代剩余容量\n   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("52.56726495150862")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("%")]),s._v(" used # 新生代使用占比\n"),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Eden")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Space")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\n   capacity "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8454144")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8.0625")]),s._v("MB"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" # "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Eden")]),s._v(" 区总容量\n   used     "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4029752")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3.8430709838867188")]),s._v("MB"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" # "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Eden")]),s._v(" 区已使用\n   free     "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4424392")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4.219429016113281")]),s._v("MB"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" # "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Eden")]),s._v(" 区剩余容量\n   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("47.665996699370154")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("%")]),s._v(" used  # "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Eden")]),s._v(" 区使用占比\n"),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("From")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Space")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" # 其中一个 "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Survivor")]),s._v(" 区的内存分布\n   capacity "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1048576")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.0")]),s._v("MB"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n   used     "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("965568")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.92083740234375")]),s._v("MB"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n   free     "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("83008")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.07916259765625")]),s._v("MB"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("92.083740234375")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("%")]),s._v(" used\n"),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("To")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Space")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" # 另一个 "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Survivor")]),s._v(" 区的内存分布\n   capacity "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1048576")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.0")]),s._v("MB"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n   used     "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v("MB"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n   free     "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1048576")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.0")]),s._v("MB"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("%")]),s._v(" used\ntenured generation"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" # 老年代\n   capacity "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20971520")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20.0")]),s._v("MB"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n   used     "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10611384")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.119804382324219")]),s._v("MB"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n   free     "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10360136")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9.880195617675781")]),s._v("MB"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("50.599021911621094")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("%")]),s._v(" used\n\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10730")]),s._v(" interned "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Strings")]),s._v(" occupying "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("906232")]),s._v(" bytes"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n")])])]),t("p",[s._v("通过查看 JVM 内存分配以及运行时使用情况，可以判断内存分配是否合理")]),s._v(" "),t("p",[s._v("另外，可以在 JVM 运行时查看最耗费资源的对象，"),t("code",[s._v("jmap -histo:live 15162 | more")])]),s._v(" "),t("p",[s._v("JVM 内存对象列表按照对象所占内存大小排序")]),s._v(" "),t("ul",[t("li",[s._v("instances：实例数")]),s._v(" "),t("li",[s._v("bytes：单位 byte")]),s._v(" "),t("li",[s._v("class name：类名")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210921195500700.png",alt:""}})]),s._v(" "),t("p",[s._v("明显看到 "),t("code",[s._v("CustomObjTest")]),s._v(" 对象实例以及占用内存过多")]),s._v(" "),t("p",[s._v("可惜的是，方案存在局限性，因为它只能排查对象占用内存过高问题")]),s._v(" "),t("p",[s._v('其中 "[" 代表数组，例如 "[C" 代表 Char 数组，"[B" 代表 Byte 数组。如果数组内存占用过多，我们不知道哪些对象持有它，所以就需要 Dump 内存进行离线分析')]),s._v(" "),t("blockquote",[t("p",[t("code",[s._v("jmap -histo:live")]),s._v(" 执行此命令，JVM 会先触发 GC，再统计信息")])]),s._v(" "),t("h2",{attrs:{id:"dump-文件分析"}},[s._v("Dump 文件分析 "),t("a",{staticClass:"header-anchor",attrs:{href:"#dump-文件分析"}},[s._v("#")])]),s._v(" "),t("p",[s._v("Dump 文件是 Java 进程的内存镜像，其中主要包括 "),t("strong",[s._v("系统信息")]),s._v("、"),t("strong",[s._v("虚拟机属性")]),s._v("、"),t("strong",[s._v("完整的线程 Dump")]),s._v("、"),t("strong",[s._v("所有类和对象的状态")]),s._v(" 等信息")]),s._v(" "),t("p",[s._v("当程序发生内存溢出或 GC 异常情况时，怀疑 JVM 发生了 "),t("strong",[s._v("内存泄漏")]),s._v("，这时我们就可以导出 Dump 文件分析")]),s._v(" "),t("p",[s._v("JVM 启动参数配置添加以下参数")]),s._v(" "),t("ul",[t("li",[s._v("-XX:+HeapDumpOnOutOfMemoryError")]),s._v(" "),t("li",[s._v("-XX:HeapDumpPath=./（参数为 Dump 文件生成路径）")])]),s._v(" "),t("blockquote",[t("p",[s._v("当 JVM 发生 OOM 异常自动导出 Dump 文件，文件名称默认格式："),t("code",[s._v("java_pid{pid}.hprof")])])]),s._v(" "),t("p",[s._v("上面配置是在应用抛出 OOM 后自动导出 Dump，或者可以在 JVM 运行时导出 Dump 文件")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("jmap -dump:file"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("文件路径"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("pid"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 示例")]),s._v("\njmap -dump:file"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("./jvmdump.hprof "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15162")]),s._v("\n")])])]),t("p",[s._v("在本地写一个测试代码，验证下 OOM 以及分析 Dump 文件")]),s._v(" "),t("div",{staticClass:"language-java extra-class"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[s._v("设置 VM 参数："),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Xms3m")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Xmx3m")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("XX"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("HeapDumpOnOutOfMemoryError")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("XX"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("HeapDumpPath")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("/\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("static")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("main")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" args"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("List")]),t("span",{pre:!0,attrs:{class:"token generics"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Object")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" oomList "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Lists")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("newArrayList")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  \t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 无限循环创建对象")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("while")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        oomList"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Object")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),t("p",[s._v("通过报错信息得知，"),t("code",[s._v("java heap space")]),s._v(" 表示 OOM 发生在堆区，并生成了 hprof 二进制文件在当前文件夹下")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210922172300122.png",alt:""}})]),s._v(" "),t("p",[t("strong",[s._v("JvisualVM 分析")])]),s._v(" "),t("p",[s._v("Dump 分析工具有很多，相对而言 "),t("strong",[s._v("JvisualVM")]),s._v("、"),t("strong",[s._v("JProfiler")]),s._v("、"),t("strong",[s._v("Eclipse Mat")]),s._v("，使用人群更多一些。下面以 JvisualVM 举例分析 Dump 文件")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210922175322692.png",alt:""}})]),s._v(" "),t("p",[s._v("列举两个常用的功能，第一个是能看到触发 OOM 的线程堆栈，清晰得知程序溢出的原因")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210924084323314.png",alt:""}})]),s._v(" "),t("p",[s._v("第二个就是可以查看 JVM 内存里保留大小最大的对象，可以自由选择排查个数")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210924084605594.png",alt:""}})]),s._v(" "),t("p",[s._v("点击对象还可以跳转具体的对象引用详情页面")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210924084719190.png",alt:""}})]),s._v(" "),t("p",[s._v("文中 Dump 文件较为简单，而正式环境出错的原因五花八门，所以不对该 Dump 文件做深度解析")]),s._v(" "),t("p",[t("strong",[s._v("注意")]),s._v("：JvisualVM 如果分析大 Dump 文件，可能会因为内存不足打不开，需要调整默认的内存")]),s._v(" "),t("h2",{attrs:{id:"总结回顾"}},[s._v("总结回顾 "),t("a",{staticClass:"header-anchor",attrs:{href:"#总结回顾"}},[s._v("#")])]),s._v(" "),t("p",[s._v("线上如遇到 JVM 内存溢出，可以分以下几步排查")]),s._v(" "),t("ol",[t("li",[t("code",[s._v("jmap -heap")]),s._v(" 查看是否内存分配过小")]),s._v(" "),t("li",[t("code",[s._v("jmap -histo")]),s._v(" 查看是否有明显的对象分配过多且没有释放情况")]),s._v(" "),t("li",[t("code",[s._v("jmap -dump")]),s._v(" 导出 JVM 当前内存快照，使用 JDK 自带或 MAT 等工具分析快照")])]),s._v(" "),t("p",[s._v("如果上面还不能定位问题，那么需要排查应用是否在不断创建资源，比如网络连接或者线程，都可能会导致系统资源耗尽")])])}),[],!1,null,null,null);a.default=e.exports}}]);