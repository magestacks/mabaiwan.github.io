(window.webpackJsonp=window.webpackJsonp||[]).push([[16],{791:function(t,s,a){"use strict";a.r(s);var n=a(118),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"图解设计模式-身份认证场景的应用"}},[t._v("图解设计模式：身份认证场景的应用 "),a("a",{staticClass:"header-anchor",attrs:{href:"#图解设计模式-身份认证场景的应用"}},[t._v("#")])]),t._v(" "),a("p",[t._v("今天和大家聊一聊，如何合理的将多种设计模式放到同一个业务场景中")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://images-machen.oss-cn-beijing.aliyuncs.com/image-20220213134923162.png",alt:""}})]),t._v(" "),a("h2",{attrs:{id:"业务背景"}},[t._v("业务背景 "),a("a",{staticClass:"header-anchor",attrs:{href:"#业务背景"}},[t._v("#")])]),t._v(" "),a("p",[t._v("最近接到一个认证的需求，C 端用户在购买公司保险时，需要先进行 "),a("strong",[t._v("实名认证确认身份")])]),t._v(" "),a("p",[t._v("为了保证业务复用，单独将认证的逻辑拆分为微服务模块")]),t._v(" "),a("p",[t._v("C 端用户下单购买保险的逻辑大致如下")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://images-machen.oss-cn-beijing.aliyuncs.com/image-20220213134419177.png",alt:""}})]),t._v(" "),a("p",[t._v("先说下关于认证相关的一些基本知识。简单来说，"),a("strong",[t._v("你如何证明你是你自己")])]),t._v(" "),a("p",[a("img",{attrs:{src:"https://images-machen.oss-cn-beijing.aliyuncs.com/image-20220213133841960.png",alt:""}})]),t._v(" "),a("p",[t._v("一些云服务厂商都会有关于验证身份的付费接口，接下来我们就以腾讯云姓名、身份证二要素认证为参考进行举例")]),t._v(" "),a("p",[t._v("说完认证知识，我们再来拆解下用户购买保险的步骤")]),t._v(" "),a("ol",[a("li",[t._v("用户在前端发起认证行为")]),t._v(" "),a("li",[t._v("请求经过网关调用保险服务，保险服务调用认证服务")]),t._v(" "),a("li",[t._v("认证服务调用腾讯云认证付费 API，返回认证结果信息")])]),t._v(" "),a("p",[a("img",{attrs:{src:"https://images-machen.oss-cn-beijing.aliyuncs.com/image-20220213134517571.png",alt:""}})]),t._v(" "),a("h2",{attrs:{id:"认证流程"}},[t._v("认证流程 "),a("a",{staticClass:"header-anchor",attrs:{href:"#认证流程"}},[t._v("#")])]),t._v(" "),a("p",[t._v("在整个块认证流程中，我们会讲解三种设计模式，按照顺序分别是策略、责任链、模板模式")]),t._v(" "),a("h3",{attrs:{id:"策略模式"}},[t._v("策略模式 "),a("a",{staticClass:"header-anchor",attrs:{href:"#策略模式"}},[t._v("#")])]),t._v(" "),a("blockquote",[a("p",[t._v("定义一组算法类，"),a("strong",[t._v("将每个算法分别封装起来，让它们可以互相替换")]),t._v("。策略模式使这些算法在客户端调用它们的时候能够互不影响地变化，客户端代指使用算法的代码")])]),t._v(" "),a("p",[t._v("我们拿认证来说，定义一个认证接口，然后实现二、三、四要素以及人脸识别实现；将这些实现类放到一个 Map 容器中，并和业务规定好对应的标识 Key，通过标识 Key 获取对应的认证策略实现")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://images-machen.oss-cn-beijing.aliyuncs.com/image-20220213182314757.png",alt:""}})]),t._v(" "),a("p",[t._v("如果真的像上面这么简单，if-else 判断加上拆解几个认证函数就可以搞得定，还真的不一定需要策略模式")]),t._v(" "),a("p",[t._v("我们再延伸来看一种复杂场景：假设后续不满足于腾讯云的认证，为了保证可用性以及更多的流量，需要对接更多的认证平台")]),t._v(" "),a("blockquote",[a("p",[t._v("可用性：平台的接口不太可能保证全年百分百可用，需要有容灾降级或者替换方案")]),t._v(" "),a("p",[t._v("更多的流量：腾讯云认证接口限流 100次 / S")])]),t._v(" "),a("p",[a("img",{attrs:{src:"https://images-machen.oss-cn-beijing.aliyuncs.com/image-20220213183053611.png",alt:""}})]),t._v(" "),a("p",[t._v("这个时候策略模式的优点就体现出来了，"),a("strong",[t._v("简化代码的复杂性")]),t._v(" 以及 "),a("strong",[t._v("保证开闭原则，增加程序的健壮性以及可扩展性")])]),t._v(" "),a("p",[t._v("后续再增加三方认证平台和认证方式，都不需要改动原有逻辑，添加对应实现即可")]),t._v(" "),a("h3",{attrs:{id:"责任链模式"}},[t._v("责任链模式 "),a("a",{staticClass:"header-anchor",attrs:{href:"#责任链模式"}},[t._v("#")])]),t._v(" "),a("blockquote",[a("p",[t._v("在责任链模式中，多个处理器（参照拦截器）依次处理同一个请求。一个请求先经过 A 处理器处理，然后再把请求传递给 B 处理器，B 处理器处理完后再传递给 C 处理器，以此类推，形成一个链条，链条上的每个处理器 "),a("strong",[t._v("各自承担各自的处理职责")])])]),t._v(" "),a("p",[t._v("这里主要将责任链模式应用于，"),a("strong",[t._v("规避无意义调用三方认证服务")])]),t._v(" "),a("ol",[a("li",[t._v("已认证过的人员信息，在有效期内没必要再次调用")]),t._v(" "),a("li",[t._v("调用认证结果错误，依然会扣钱，比如说名称中包含非中文，身份证格式错误等等")])]),t._v(" "),a("p",[a("img",{attrs:{src:"https://images-machen.oss-cn-beijing.aliyuncs.com/image-20220213205418481.png",alt:""}})]),t._v(" "),a("p",[t._v("我们可以将处理器尽量职责单一，方便后续其它认证方式的 "),a("strong",[t._v("复用和编排")])]),t._v(" "),a("h3",{attrs:{id:"模板方法"}},[t._v("模板方法 "),a("a",{staticClass:"header-anchor",attrs:{href:"#模板方法"}},[t._v("#")])]),t._v(" "),a("blockquote",[a("p",[t._v("模板方法模式在一个方法中定义一个 "),a("strong",[t._v("算法骨架")]),t._v("，并将某些步骤推迟到 "),a("strong",[t._v("子类中实现")]),t._v("。模板方法模式可以让子类在 "),a("strong",[t._v("不改变算法整体结构的情况下，重新定义算法中的某些步骤")])])]),t._v(" "),a("p",[a("img",{attrs:{src:"https://images-machen.oss-cn-beijing.aliyuncs.com/format,png.png",alt:""}})]),t._v(" "),a("p",[t._v("模版方法主要作用："),a("strong",[t._v("复用性")]),t._v(" 和 "),a("strong",[t._v("扩展性")])]),t._v(" "),a("ul",[a("li",[t._v("复用性：核心思想就是 "),a("strong",[t._v("父级定义公共实现")]),t._v("，"),a("strong",[t._v("由子级进行调取使用")])]),t._v(" "),a("li",[t._v("扩展性："),a("strong",[t._v("在不修改方法逻辑的前提下，变更其中的某些步骤")])])]),t._v(" "),a("p",[t._v("通俗来讲 : 定义一个抽象类 "),a("code",[t._v("AbstractTemplate")]),t._v("，并定义一个或若干抽象方法 "),a("code",[t._v("abstractMethod")]),t._v("。代码大致如下：")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("abstract")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("AbstractAuthenticationService")]),a("span",{pre:!0,attrs:{class:"token generics"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("T")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("extends")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("AuthenticationRequest")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("before")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("T")]),t._v(" request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("after")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("T")]),t._v(" request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n  \t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 抽象方法")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("protected")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("abstract")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("practicalExecute")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("T")]),t._v(" request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("authentication")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("T")]),t._v(" request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      \t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 前置拦截操作，包括不限于责任链模式调用")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("before")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      \t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 策略模式实现，调用具体认证类，比如二要素认证或三要素认证")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("practicalExecute")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      \t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 资源清理或记录认证完成信息")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("after")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("腾讯云二要素认证实现类，代码如下：")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Slf4j")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Component")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@RequiredArgsConstructor")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// BaseAuthenticationStrategy 是策略模式实现，定义了 mark、execute 方法")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("NameIdCardAuthenticationByTencentResolver")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("extends")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("AbstractAuthenticationService")]),a("span",{pre:!0,attrs:{class:"token generics"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("NameIdCardAuthenticationReqDTO")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("implements")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("BaseAuthenticationStrategy")]),a("span",{pre:!0,attrs:{class:"token generics"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("NameIdCardAuthenticationReqDTO")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" SUCCESS "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  \t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 责任链容器")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("NameIdCardHandlerChain")]),t._v(" nameIdCardHandlerChain"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Override")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("mark")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("AuthenticationEnum")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("TENCENT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Override")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("execute")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("NameIdCardAuthenticationReqDTO")]),t._v(" request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("authentication")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Override")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("before")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("NameIdCardAuthenticationReqDTO")]),t._v(" request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      \t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 责任链调用")]),t._v("\n        nameIdCardHandlerChain"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("doFilter")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Override")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("practicalExecute")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("NameIdCardAuthenticationReqDTO")]),t._v(" request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 腾讯云二要素认证具体行为")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h2",{attrs:{id:"最后总结"}},[t._v("最后总结 "),a("a",{staticClass:"header-anchor",attrs:{href:"#最后总结"}},[t._v("#")])]),t._v(" "),a("p",[t._v("抛出一个老生常谈的问题，"),a("strong",[t._v("学习设计模式有什么作用？")])]),t._v(" "),a("p",[t._v("设计模式主要是为了应对 "),a("strong",[t._v("代码的复杂性")]),t._v("，让其满足 "),a("strong",[t._v("开闭原则")]),t._v("，提高代码的 "),a("strong",[t._v("扩展性")]),t._v("；合适的场景合理运用的设计模式，可以帮助代码实现 "),a("strong",[t._v("高内聚、低耦合")]),t._v(" 等的优点")]),t._v(" "),a("p",[t._v("你无法决定别人的代码，但你可以决定自己的。时间充足的情况下，"),a("strong",[t._v("尽量以重构的方式去写每一行代码")])]),t._v(" "),a("p",[t._v("最后希望小伙伴读过文章后有所收获，祝好。")])])}),[],!1,null,null,null);s.default=e.exports}}]);